# TravelDot - 功能規格文件 (Functional Spec)

## 目的

本文件詳細描述每個功能的操作反饋、狀態變換、邊界案例 (Edge Cases) 的處理方式。

---

## 1. 使用者認證與帳號管理

### 1.1 註冊新帳號

#### 操作流程
1. 使用者訪問登入頁面
2. 點擊「Sign up」連結
3. 進入註冊頁面
4. 輸入 Email 與 Password
5. 點擊「Sign up」按鈕
6. 系統驗證輸入
7. 建立帳號
8. 自動登入
9. 跳轉到 Landing Page

#### 狀態變換
```
[未登入] → [註冊頁面] → [驗證中] → [建立帳號] → [已登入] → [Landing Page]
```

#### 驗證規則
- **Email 格式驗證**：
  - 必須符合標準 Email 格式（包含 @ 與網域）
  - 即時驗證（blur 事件觸發）
  - 錯誤訊息：「請輸入有效的 Email」
  
- **密碼強度驗證**：
  - 最少 8 個字元
  - 即時驗證（blur 事件觸發）
  - 錯誤訊息：「密碼至少需要 8 個字元」

#### 邊界案例處理

**Case 1: Email 已被使用**
```
Given: Email "test@example.com" 已被註冊
When: 使用者嘗試用相同 Email 註冊
Then: 
  - 顯示錯誤 Alert: "此 Email 已被使用，請使用其他 Email 或登入"
  - 保持在註冊頁面
  - 按鈕恢復正常狀態
  - Email 欄位保持填入狀態
  - Password 欄位清空
```

**Case 2: 網路連線中斷**
```
Given: 使用者填寫完註冊表單
When: 點擊「Sign up」按鈕時網路中斷
Then:
  - 按鈕顯示 loading 狀態
  - 等待 10 秒後顯示錯誤訊息
  - 錯誤訊息：「網路連線失敗，請檢查網路後重試」
  - 按鈕恢復正常狀態
  - 表單資料保留
```

**Case 3: Firebase 服務異常**
```
Given: Firebase Authentication 服務暫時無法使用
When: 使用者點擊「Sign up」按鈕
Then:
  - 顯示錯誤訊息：「系統暫時無法使用，請稍後再試」
  - 按鈕恢復正常狀態
  - 表單資料保留
```

#### 錯誤處理
- **驗證錯誤**：即時顯示在輸入框下方，紅色文字
- **系統錯誤**：顯示 Alert 或 Toast，包含明確的錯誤訊息與建議動作
- **按鈕狀態**：錯誤發生後恢復為可點擊狀態

---

### 1.2 登入

#### 操作流程
1. 使用者訪問登入頁面
2. 輸入 Email 與 Password
3. 點擊「Login」按鈕
4. 系統驗證憑證
5. 登入成功
6. 跳轉到 Landing Page

#### 狀態變換
```
[未登入] → [登入頁面] → [驗證中] → [已登入] → [Landing Page]
```

#### 邊界案例處理

**Case 1: 錯誤的密碼**
```
Given: 使用者輸入正確的 Email 但錯誤的 Password
When: 點擊「Login」按鈕
Then:
  - 顯示錯誤 Alert: "帳號或密碼錯誤，請重試"
  - 保持在登入頁面
  - Password 欄位清空
  - Focus 回到 Password 欄位
  - Email 欄位保持填入狀態
```

**Case 2: 帳號不存在**
```
Given: 使用者輸入未註冊的 Email
When: 點擊「Login」按鈕
Then:
  - 顯示錯誤 Alert: "帳號或密碼錯誤，請重試"
  - （不透露帳號是否存在，避免安全問題）
  - Password 欄位清空
  - Focus 回到 Email 欄位
```

**Case 3: 多次登入失敗**
```
Given: 使用者連續 5 次登入失敗
When: 第 6 次點擊「Login」按鈕
Then:
  - 顯示錯誤訊息: "登入失敗次數過多，請 15 分鐘後再試"
  - 按鈕變為 disabled 狀態
  - 顯示倒數計時器
  - 15 分鐘後自動恢復
```

#### 按鈕 Loading 狀態
```
Normal State:
  - 按鈕文字: "Login"
  - 背景色: Primary Color
  - Cursor: pointer

Loading State:
  - 按鈕文字: "登入中..."
  - 顯示 spinner icon
  - 背景色: Primary Color (50% opacity)
  - Cursor: not-allowed
  - Disabled: true
```

---

### 1.3 忘記密碼

#### 操作流程
1. 使用者在登入頁面點擊「Forgot password?」
2. 彈出 Modal 顯示 Email 輸入框
3. 輸入 Email
4. 點擊「Send reset link」
5. 系統發送重設連結到 Email
6. 顯示成功訊息
7. 關閉 Modal

#### 狀態變換
```
[登入頁面] → [忘記密碼 Modal] → [發送中] → [發送成功] → [關閉 Modal]
```

#### 邊界案例處理

**Case 1: Email 不存在**
```
Given: 使用者輸入未註冊的 Email
When: 點擊「Send reset link」
Then:
  - 仍然顯示成功訊息（避免洩漏帳號是否存在）
  - 訊息: "重設連結已發送到您的信箱"
  - 實際上不發送 Email
  - 關閉 Modal
```

**Case 2: Email 格式錯誤**
```
Given: 使用者輸入無效的 Email 格式
When: 失焦輸入框
Then:
  - 顯示錯誤訊息: "請輸入有效的 Email"
  - 按鈕變為 disabled 狀態
  - 輸入框 border 變紅色
```

**Case 3: 短時間內多次請求**
```
Given: 使用者在 1 分鐘內已發送 3 次重設連結
When: 第 4 次點擊「Send reset link」
Then:
  - 顯示錯誤訊息: "請求過於頻繁，請 1 分鐘後再試"
  - 按鈕變為 disabled 狀態
  - 顯示倒數計時器
```

---

## 2. 旅程管理

### 2.1 建立新旅程

#### 操作流程
1. 使用者在 Landing Page 點擊「+ New Trip」
2. 彈出「建立旅程」Modal
3. 輸入旅程名稱、開始日期、結束日期
4. （選填）上傳封面照片
5. 點擊「建立」按鈕
6. 系統建立旅程
7. Modal 關閉
8. 新旅程出現在列表最前方

#### 狀態變換
```
[Landing Page] → [建立旅程 Modal] → [驗證中] → [建立中] → [建立成功] → [更新列表]
```

#### 驗證規則
- **旅程名稱**：必填，1-100 字元
- **開始日期**：必填，不能早於 1900-01-01
- **結束日期**：必填，不能早於開始日期
- **封面照片**：選填，限制 10MB，格式 jpg/png/webp

#### 邊界案例處理

**Case 1: 旅程名稱為空**
```
Given: 使用者未輸入旅程名稱
When: 點擊「建立」按鈕
Then:
  - 顯示錯誤訊息: "請輸入旅程名稱"
  - 輸入框 border 變紅色
  - Modal 不關閉
  - Focus 到名稱輸入框
```

**Case 2: 結束日期早於開始日期**
```
Given: 使用者選擇開始日期 2024/03/15，結束日期 2024/03/01
When: 點擊「建立」按鈕
Then:
  - 顯示錯誤訊息: "結束日期不能早於開始日期"
  - 結束日期輸入框 border 變紅色
  - Modal 不關閉
  - Focus 到結束日期輸入框
```

**Case 3: 封面照片過大**
```
Given: 使用者上傳 15MB 的照片
When: 選擇檔案
Then:
  - 顯示錯誤訊息: "照片大小不能超過 10MB"
  - 不上傳檔案
  - 清空檔案選擇
```

**Case 4: 封面照片格式錯誤**
```
Given: 使用者上傳 .gif 或 .bmp 檔案
When: 選擇檔案
Then:
  - 顯示錯誤訊息: "只支援 jpg、png、webp 格式"
  - 不上傳檔案
  - 清空檔案選擇
```

**Case 5: 建立過程中網路中斷**
```
Given: 使用者填寫完表單並點擊「建立」
When: 上傳過程中網路中斷
Then:
  - 顯示錯誤訊息: "建立失敗，請檢查網路後重試"
  - 按鈕恢復正常狀態
  - Modal 不關閉
  - 表單資料保留
```

---

### 2.2 編輯旅程

#### 操作流程
1. 使用者右鍵點擊（或長按）Trip Card
2. 顯示選單（編輯、刪除、分享）
3. 點擊「編輯」
4. 彈出編輯 Modal，預填現有資料
5. 修改資料
6. 點擊「儲存」
7. 系統更新旅程
8. Modal 關閉
9. Trip Card 顯示更新後的資料

#### 狀態變換
```
[Landing Page] → [右鍵選單] → [編輯 Modal] → [驗證中] → [更新中] → [更新成功] → [更新 UI]
```

#### 邊界案例處理

**Case 1: 修改後名稱為空**
```
Given: 使用者清空旅程名稱
When: 點擊「儲存」
Then:
  - 顯示錯誤訊息: "請輸入旅程名稱"
  - 輸入框 border 變紅色
  - Modal 不關閉
  - Focus 到名稱輸入框
```

**Case 2: 更新過程中旅程被刪除**
```
Given: 使用者在另一個裝置刪除了此旅程
When: 點擊「儲存」
Then:
  - 顯示錯誤訊息: "此旅程已被刪除"
  - Modal 關閉
  - 從列表中移除此 Trip Card
```

---

### 2.3 刪除旅程

#### 操作流程
1. 使用者右鍵點擊 Trip Card
2. 選擇「刪除」
3. 彈出確認對話框
4. 點擊「確定刪除」
5. 系統刪除旅程與所有相關資料
6. Trip Card 以動畫方式消失
7. 顯示 Toast: "旅程已刪除"

#### 狀態變換
```
[Landing Page] → [右鍵選單] → [確認對話框] → [刪除中] → [刪除成功] → [更新 UI]
```

#### 邊界案例處理

**Case 1: 刪除過程中網路中斷**
```
Given: 使用者點擊「確定刪除」
When: 刪除過程中網路中斷
Then:
  - 顯示錯誤訊息: "刪除失敗，請檢查網路後重試"
  - 對話框關閉
  - Trip Card 保持顯示
  - 提供「重試」按鈕
```

**Case 2: 旅程包含大量地點（> 100 個）**
```
Given: 旅程包含 150 個地點
When: 點擊「確定刪除」
Then:
  - 顯示進度條: "正在刪除... (50/150)"
  - 批次刪除地點（每批 10 個）
  - 刪除完成後顯示 Toast
  - Trip Card 消失
```

**Case 3: 刪除過程中使用者取消**
```
Given: 刪除正在進行中
When: 使用者點擊「取消」或按 ESC
Then:
  - 停止刪除操作
  - 顯示訊息: "刪除已取消"
  - 已刪除的地點不會恢復
  - Trip Card 保持顯示（但地點數量可能減少）
```

---

## 3. 地圖介面與地點標記

### 3.1 顯示地圖與地點

#### 操作流程
1. 使用者點擊 Trip Card
2. 跳轉到地圖頁面
3. 載入 Google Maps
4. 從 Firestore 讀取地點資料
5. 在地圖上顯示 Pin 標記
6. 自動調整地圖中心與縮放

#### 狀態變換
```
[Landing Page] → [載入中] → [地圖顯示] → [地點標記顯示] → [自動調整視野]
```

#### 效能要求
- **地圖載入時間**：< 2 秒
- **地點標記渲染**：< 0.3 秒
- **自動調整視野**：< 0.5 秒

#### 邊界案例處理

**Case 1: 旅程沒有任何地點**
```
Given: 旅程的地點數量為 0
When: 進入地圖頁面
Then:
  - 地圖顯示預設位置（台灣中心）
  - 顯示提示: "還沒有地點，點擊右下角 + 按鈕開始記錄吧！"
  - FAB 按鈕閃爍動畫（吸引注意）
```

**Case 2: 地點數量過多（> 1000 個）**
```
Given: 旅程包含 1500 個地點
When: 進入地圖頁面
Then:
  - 只載入當前視野範圍內的地點（viewport-based loading）
  - 地圖移動時動態載入新地點
  - 使用虛擬化技術避免效能問題
  - 側邊欄列表使用無限滾動
```

**Case 3: Google Maps API 載入失敗**
```
Given: Google Maps API 無法載入（網路問題或 API Key 錯誤）
When: 進入地圖頁面
Then:
  - 顯示錯誤訊息: "地圖載入失敗，請檢查網路連線"
  - 提供「重試」按鈕
  - 顯示地點列表作為備用介面
```

**Case 4: 地點座標無效**
```
Given: 某個地點的座標為 null 或超出範圍
When: 渲染地點標記
Then:
  - 跳過該地點的標記
  - 在側邊欄列表中標示為「位置資訊錯誤」
  - 記錄錯誤到 console
  - 不影響其他地點的顯示
```

---

### 3.2 地點聚合 (Clustering)

#### 操作流程
1. 地圖載入完成
2. 計算地點之間的距離
3. 根據 zoom level 決定是否聚合
4. 顯示 cluster 或獨立 Pin

#### 聚合規則
- **Zoom level ≥ 12**：顯示獨立 Pin
- **Zoom level < 12**：相近地點聚合為 cluster
- **Cluster 尺寸**：
  - 2-10 個地點：40px
  - 11-50 個地點：50px
  - 51+ 個地點：60px

#### 狀態變換
```
[地圖縮放] → [計算聚合] → [更新 Cluster] → [渲染完成]
```

#### 邊界案例處理

**Case 1: Cluster 包含 1000+ 個地點**
```
Given: 某個 cluster 包含 1200 個地點
When: 顯示 cluster
Then:
  - 顯示數量為 "1000+"
  - Cluster 尺寸為 60px
  - 點擊後分階段 zoom in（避免一次展開過多地點）
```

**Case 2: 快速連續縮放地圖**
```
Given: 使用者快速滾動滑鼠滾輪
When: Zoom level 快速變化
Then:
  - 使用 debounce（300ms）避免過度計算
  - 只在縮放停止後重新計算聚合
  - 顯示 loading 狀態（半透明 overlay）
```

---

### 3.3 新增地點（搜尋）

#### 操作流程
1. 使用者點擊 FAB (+) 按鈕
2. 展開選單
3. 點擊「搜尋地點」
4. 彈出全螢幕搜尋介面
5. 輸入關鍵字
6. 即時顯示 Google Places 建議
7. 點擊建議
8. 地圖中心移到該地點
9. 開啟編輯器 Modal

#### 狀態變換
```
[地圖頁面] → [FAB 選單] → [搜尋介面] → [輸入中] → [顯示建議] → [選擇地點] → [編輯器]
```

#### 效能要求
- **搜尋響應時間**：< 500ms
- **建議顯示**：即時（使用 debounce 300ms）

#### 邊界案例處理

**Case 1: 搜尋無結果**
```
Given: 使用者輸入 "asdfghjkl"
When: Google Places API 回傳空結果
Then:
  - 顯示訊息: "找不到相關地點，請嘗試其他關鍵字"
  - 提供建議: "或使用「在地圖上選點」功能"
  - 保持搜尋介面開啟
```

**Case 2: 網路緩慢**
```
Given: 網路速度 < 100KB/s
When: 輸入搜尋關鍵字
Then:
  - 顯示 loading spinner
  - 等待最多 5 秒
  - 5 秒後顯示錯誤訊息: "搜尋逾時，請檢查網路連線"
```

**Case 3: Google Places API 配額用盡**
```
Given: Google Places API 每日配額已用完
When: 使用者搜尋地點
Then:
  - 顯示錯誤訊息: "搜尋功能暫時無法使用"
  - 自動切換到「在地圖上選點」模式
  - 記錄錯誤到監控系統
```

**Case 4: 搜尋結果過多（> 20 個）**
```
Given: 搜尋 "cafe" 回傳 50 個結果
When: 顯示建議列表
Then:
  - 只顯示前 20 個結果
  - 底部顯示: "顯示前 20 個結果，請輸入更具體的關鍵字"
  - 支援捲動載入更多（無限滾動）
```

---

### 3.4 新增地點（當前位置）

#### 操作流程
1. 使用者點擊「使用當前位置」
2. 請求位置權限（如果尚未授予）
3. 獲取 GPS 座標
4. 地圖中心移到當前位置
5. 顯示藍色 Pin
6. 開啟編輯器 Modal

#### 狀態變換
```
[FAB 選單] → [請求權限] → [定位中] → [定位成功] → [移動地圖] → [編輯器]
```

#### 效能要求
- **GPS 定位時間**：< 3 秒

#### 邊界案例處理

**Case 1: 位置權限被拒絕**
```
Given: 使用者點擊「拒絕」位置權限
When: 瀏覽器彈出權限請求
Then:
  - 顯示 Toast: "需要位置權限才能使用此功能"
  - 提供「設定」連結（引導使用者到瀏覽器設定）
  - 保持在地圖頁面
```

**Case 2: GPS 定位失敗**
```
Given: 裝置無法獲取 GPS 訊號（室內或訊號不良）
When: 等待 3 秒後仍無法定位
Then:
  - 顯示錯誤訊息: "無法獲取位置，請確認 GPS 已開啟"
  - 提供「重試」按鈕
  - 提供「改用搜尋」按鈕
```

**Case 3: GPS 精度不足**
```
Given: GPS 精度 > 100 公尺
When: 獲取位置成功
Then:
  - 顯示警告訊息: "位置精度較低，可能不準確"
  - 在地圖上顯示精度範圍圓圈
  - 允許使用者手動調整位置
```

---

### 3.5 新增地點（地圖選點）

#### 操作流程
1. 使用者點擊「在地圖上選點」
2. 進入「選點模式」
3. 地圖中央顯示十字準星
4. 拖動地圖調整位置
5. 點擊「確認位置」
6. 在十字準星位置放置 Pin
7. 開啟編輯器 Modal

#### 狀態變換
```
[FAB 選單] → [選點模式] → [拖動地圖] → [確認位置] → [放置 Pin] → [編輯器]
```

#### 邊界案例處理

**Case 1: 使用者取消選點**
```
Given: 使用者在選點模式中
When: 點擊「取消」按鈕或按 ESC
Then:
  - 退出選點模式
  - 地圖恢復正常狀態
  - 十字準星消失
  - 不建立地點
```

**Case 2: 選點位置在海洋或無效區域**
```
Given: 使用者選擇的位置在海洋中
When: 點擊「確認位置」
Then:
  - 顯示警告訊息: "此位置可能不正確，確定要繼續嗎？"
  - 提供「確定」與「重新選擇」按鈕
  - 如果確定，仍然允許建立地點
```

---

## 4. 內容編輯器

### 4.1 編輯地點內容

#### 操作流程
1. 開啟編輯器 Modal
2. 預填地點名稱、地址、座標
3. 輸入文字內容
4. 上傳照片
5. 新增標籤
6. 設定評分
7. 設定公開/私密
8. 點擊「儲存」
9. 資料儲存到 Firestore
10. Modal 關閉
11. 地圖與側邊欄更新

#### 狀態變換
```
[開啟編輯器] → [輸入內容] → [驗證] → [儲存中] → [儲存成功] → [更新 UI]
```

#### 驗證規則
- **地點名稱**：必填，1-200 字元
- **日期時間**：必填，不能晚於今天
- **評分**：選填，1-5 星
- **標籤**：選填，每個標籤 1-20 字元，最多 10 個標籤

#### 邊界案例處理

**Case 1: 地點名稱為空**
```
Given: 使用者未輸入地點名稱
When: 點擊「儲存」
Then:
  - 顯示錯誤訊息: "請輸入地點名稱"
  - 輸入框 border 變紅色
  - 捲動到該欄位
  - Focus 到該欄位
  - Modal 不關閉
```

**Case 2: 日期晚於今天**
```
Given: 使用者選擇明天的日期
When: 失焦日期輸入框
Then:
  - 顯示警告訊息: "日期不能晚於今天"
  - 自動調整為今天
```

**Case 3: 儲存過程中網路中斷**
```
Given: 使用者點擊「儲存」
When: 上傳過程中網路中斷
Then:
  - 顯示錯誤訊息: "儲存失敗，請檢查網路後重試"
  - 按鈕恢復正常狀態
  - Modal 不關閉
  - 表單資料保留
  - 提供「重試」按鈕
```

**Case 4: Firestore 寫入失敗**
```
Given: Firestore 達到寫入限制或服務異常
When: 點擊「儲存」
Then:
  - 顯示錯誤訊息: "儲存失敗，請稍後再試"
  - 將資料暫存到 localStorage
  - 提供「稍後重試」按鈕
  - 下次開啟編輯器時提示恢復資料
```

---

### 4.2 上傳照片

#### 操作流程
1. 點擊「+ 新增照片」或拖曳照片到編輯器
2. 選擇照片檔案（可多選）
3. 顯示上傳進度條
4. 自動壓縮照片（< 1MB）
5. 上傳到 Firebase Storage
6. 顯示縮圖
7. 可為每張照片加 caption

#### 狀態變換
```
[選擇檔案] → [驗證] → [壓縮] → [上傳中] → [上傳成功] → [顯示縮圖]
```

#### 效能要求
- **壓縮時間**：< 2 秒/張
- **上傳時間**：< 3 秒/張（1MB 檔案）
- **整個流程**：< 5 秒（3 張照片）

#### 邊界案例處理

**Case 1: 照片過大（> 10MB）**
```
Given: 使用者選擇 15MB 的照片
When: 選擇檔案
Then:
  - 顯示錯誤訊息: "照片大小不能超過 10MB"
  - 不上傳該檔案
  - 其他符合條件的照片正常上傳
```

**Case 2: 照片格式錯誤**
```
Given: 使用者選擇 .gif 或 .bmp 檔案
When: 選擇檔案
Then:
  - 顯示錯誤訊息: "只支援 jpg、png、webp 格式"
  - 不上傳該檔案
  - 其他符合條件的照片正常上傳
```

**Case 3: 批次上傳過多照片（> 20 張）**
```
Given: 使用者選擇 30 張照片
When: 選擇檔案
Then:
  - 顯示警告訊息: "一次最多上傳 20 張照片"
  - 只上傳前 20 張
  - 提示使用者可以分批上傳
```

**Case 4: 上傳過程中網路中斷**
```
Given: 正在上傳第 3 張照片（共 5 張）
When: 網路中斷
Then:
  - 暫停上傳
  - 顯示錯誤訊息: "網路連線中斷"
  - 已上傳的照片保留
  - 提供「繼續上傳」按鈕
  - 點擊後從中斷處繼續
```

**Case 5: Firebase Storage 配額用盡**
```
Given: Firebase Storage 空間已滿
When: 上傳照片
Then:
  - 顯示錯誤訊息: "儲存空間已滿，請升級方案或刪除舊照片"
  - 提供「管理儲存空間」連結
  - 不上傳照片
```

**Case 6: 照片壓縮失敗**
```
Given: 照片檔案損壞或格式異常
When: 壓縮照片
Then:
  - 顯示錯誤訊息: "照片處理失敗，請嘗試其他照片"
  - 跳過該照片
  - 繼續處理其他照片
```

---

### 4.3 標籤管理

#### 操作流程
1. 點擊「+ 新增標籤」
2. 彈出輸入框
3. 輸入標籤名稱
4. （自動顯示建議）
5. 按 Enter 或點擊建議
6. 新增標籤 chip
7. 可點擊 X 刪除標籤

#### 狀態變換
```
[點擊新增] → [輸入框] → [輸入中] → [顯示建議] → [確認] → [新增 chip]
```

#### 邊界案例處理

**Case 1: 標籤名稱過長（> 20 字元）**
```
Given: 使用者輸入 25 個字元的標籤
When: 按 Enter
Then:
  - 顯示錯誤訊息: "標籤最多 20 個字元"
  - 輸入框保持開啟
  - 不新增標籤
```

**Case 2: 標籤重複**
```
Given: 已存在標籤「咖啡」
When: 使用者再次輸入「咖啡」
Then:
  - 顯示訊息: "此標籤已存在"
  - 輸入框清空
  - 不新增重複標籤
```

**Case 3: 標籤數量過多（> 10 個）**
```
Given: 已有 10 個標籤
When: 使用者嘗試新增第 11 個標籤
Then:
  - 顯示訊息: "最多 10 個標籤"
  - 「+ 新增標籤」按鈕變為 disabled
```

**Case 4: 標籤包含特殊字元**
```
Given: 使用者輸入「咖啡@#$」
When: 按 Enter
Then:
  - 自動移除特殊字元，保留「咖啡」
  - 新增標籤「咖啡」
  - 顯示提示: "已移除特殊字元"
```

---

## 5. 瀏覽與篩選

### 5.1 側邊欄顯示地點列表（桌面版）

#### 操作流程
1. 進入地圖頁面
2. 右側顯示側邊欄
3. 顯示旅程名稱與地點總數
4. 顯示地點列表（按日期倒序）
5. 點擊列表項目
6. 地圖中心移到該地點
7. 彈出 Place Preview Card

#### 狀態變換
```
[載入頁面] → [顯示側邊欄] → [載入列表] → [點擊項目] → [移動地圖] → [顯示 Preview]
```

#### 邊界案例處理

**Case 1: 地點列表過長（> 100 個）**
```
Given: 旅程包含 200 個地點
When: 顯示側邊欄列表
Then:
  - 使用虛擬滾動（只渲染可見項目）
  - 初始載入前 20 個項目
  - 捲動時動態載入更多
  - 顯示捲動位置指示器
```

**Case 2: 側邊欄收合後再展開**
```
Given: 使用者點擊收合按鈕
When: 側邊欄收合
Then:
  - 側邊欄向右滑出（300ms）
  - 地圖寬度擴展到 100%
  - 收合按鈕變成「▶」
When: 再次點擊展開
Then:
  - 側邊欄滑回來（300ms）
  - 地圖寬度恢復 70%
  - 保持之前的捲動位置
```

---

### 5.2 篩選地點

#### 操作流程
1. 點擊 Header 的「Filter」按鈕
2. 彈出篩選 Modal
3. 選擇標籤
4. 點擊「套用」
5. 地圖與側邊欄只顯示符合的地點
6. Header 顯示篩選狀態

#### 狀態變換
```
[點擊 Filter] → [篩選 Modal] → [選擇條件] → [套用] → [更新地圖] → [更新列表]
```

#### 邊界案例處理

**Case 1: 篩選結果為空**
```
Given: 使用者選擇標籤「#博物館」
When: 沒有任何地點有此標籤
Then:
  - 地圖顯示訊息: "沒有符合條件的地點"
  - 側邊欄顯示空狀態
  - 提供「清除篩選」按鈕
```

**Case 2: 多重篩選條件**
```
Given: 使用者選擇標籤「#咖啡」與日期範圍「2024/03/01-2024/03/10」
When: 套用篩選
Then:
  - 顯示同時符合兩個條件的地點（AND 邏輯）
  - Header 顯示: "篩選中 (2)"
  - 可分別移除單一條件
```

**Case 3: 篩選狀態下新增地點**
```
Given: 正在篩選標籤「#咖啡」
When: 使用者新增一個有「#咖啡」標籤的地點
Then:
  - 新地點立即出現在地圖與列表中
  - 保持篩選狀態
When: 使用者新增一個沒有「#咖啡」標籤的地點
Then:
  - 新地點不顯示（因為不符合篩選條件）
  - 顯示提示: "新地點已建立，但不符合目前篩選條件"
```

---

## 6. 資料匯出

### 6.1 匯出所有資料

#### 操作流程
1. 在設定頁面點擊「匯出資料」
2. 顯示確認 Modal（預估檔案大小）
3. 點擊「開始匯出」
4. 顯示進度條
5. 產生 ZIP 檔案
6. 自動下載
7. 顯示 Toast: "資料已匯出"

#### 狀態變換
```
[設定頁面] → [確認 Modal] → [匯出中] → [產生 ZIP] → [下載] → [完成]
```

#### 效能要求
- **小型資料（< 100 個地點）**：< 10 秒
- **中型資料（100-500 個地點）**：< 30 秒
- **大型資料（> 500 個地點）**：< 60 秒

#### 邊界案例處理

**Case 1: 匯出過程中網路中斷**
```
Given: 正在下載照片檔案
When: 網路中斷
Then:
  - 暫停匯出
  - 顯示錯誤訊息: "網路連線中斷"
  - 保留已下載的資料
  - 提供「繼續匯出」按鈕
  - 點擊後從中斷處繼續
```

**Case 2: 資料量過大（> 5GB）**
```
Given: 使用者有 2000 個地點，總共 6GB 照片
When: 點擊「開始匯出」
Then:
  - 顯示警告訊息: "資料量過大，建議分批匯出"
  - 提供選項: "匯出所有資料" 或 "選擇旅程匯出"
  - 如果選擇所有資料，分批下載（每批 1GB）
```

**Case 3: 瀏覽器儲存空間不足**
```
Given: 瀏覽器可用空間 < 匯出檔案大小
When: 產生 ZIP 檔案
Then:
  - 顯示錯誤訊息: "儲存空間不足"
  - 建議清理瀏覽器快取或選擇較小的匯出範圍
  - 提供「選擇旅程匯出」選項
```

**Case 4: ZIP 檔案產生失敗**
```
Given: ZIP 壓縮過程中發生錯誤
When: 產生 ZIP 檔案
Then:
  - 顯示錯誤訊息: "匯出失敗，請重試"
  - 記錄錯誤到 console
  - 提供「重試」按鈕
  - 清理暫存資料
```

---

## 7. 跨功能互動

### 7.1 同時編輯同一旅程（多裝置）

**情境**：使用者在手機與電腦上同時開啟同一個旅程

**處理方式**：
- Firestore 即時同步資料
- 其他裝置的變更會即時反映在當前裝置
- 如果同時編輯同一個地點，後儲存的覆蓋先儲存的
- 顯示提示: "此地點已在其他裝置更新"

### 7.2 刪除旅程時正在編輯地點

**情境**：使用者在電腦上刪除旅程，同時在手機上編輯該旅程的地點

**處理方式**：
- 手機上的編輯器顯示錯誤: "此旅程已被刪除"
- 自動關閉編輯器
- 跳轉到 Landing Page
- 不儲存編輯內容

### 7.3 網路從離線恢復到線上

**情境**：使用者在離線狀態下操作，然後網路恢復

**處理方式**：
- 檢測到網路恢復
- 顯示 Toast: "網路已恢復，正在同步資料..."
- 自動重試失敗的操作
- 同步完成後顯示: "同步完成"

---

## 8. 錯誤處理總覽

### 8.1 錯誤訊息設計原則
- **明確**：清楚說明發生了什麼問題
- **建設性**：提供解決方案或下一步建議
- **友善**：使用平易近人的語言，避免技術術語
- **一致**：相同類型的錯誤使用相同的訊息格式

### 8.2 錯誤訊息範例

| 錯誤類型 | 訊息 | 建議動作 |
|---------|------|---------|
| 網路錯誤 | "網路連線失敗，請檢查網路後重試" | 提供「重試」按鈕 |
| 驗證錯誤 | "請輸入有效的 Email" | Focus 到錯誤欄位 |
| 權限錯誤 | "需要位置權限才能使用此功能" | 提供「設定」連結 |
| 配額錯誤 | "儲存空間已滿，請升級方案或刪除舊照片" | 提供「管理儲存空間」連結 |
| 系統錯誤 | "系統暫時無法使用，請稍後再試" | 記錄錯誤到監控系統 |

### 8.3 錯誤恢復策略
- **自動重試**：網路錯誤自動重試 3 次（間隔 1s, 2s, 4s）
- **資料暫存**：失敗的操作暫存到 localStorage
- **離線支援**：（Phase 2）離線時記錄操作，線上時同步
- **錯誤監控**：所有錯誤記錄到監控系統（如 Sentry）

---

## 附錄

### A. 狀態碼對照表

| 狀態碼 | 說明 | 處理方式 |
|-------|------|---------|
| 200 | 成功 | 正常處理 |
| 400 | 請求錯誤 | 顯示驗證錯誤訊息 |
| 401 | 未授權 | 跳轉到登入頁面 |
| 403 | 權限不足 | 顯示權限錯誤訊息 |
| 404 | 資源不存在 | 顯示「找不到資源」訊息 |
| 429 | 請求過於頻繁 | 顯示倒數計時器 |
| 500 | 伺服器錯誤 | 顯示「系統暫時無法使用」訊息 |

### B. 參考文件
- [PRD.md](./PRD.md)：產品需求文件
- [ACCEPTANCE_CRITERIA.md](./ACCEPTANCE_CRITERIA.md)：驗收標準
- [DESIGN_SPEC.md](./DESIGN_SPEC.md)：設計規格
- [TECH_SPEC.md](./TECH_SPEC.md)：技術規格
